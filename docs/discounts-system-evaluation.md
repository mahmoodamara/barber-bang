# تقييم نظام التنزيلات (קופונים, הצעות, קמפיינים, מתנות)

## ملخص تنفيذي

النظام **مبني بشكل احترافي** و**منطق الحساب صحيح ومتسق**. ترتيب التطبيق واضح، والحدود (ستوك، استخدام كوبون، حملة واحدة، سقف الخصم) مُطبَّقة بشكل صحيح. التقييم الإجمالي: **9/10** — جاهز للإنتاج مع ملاحظات صغيرة للتحسين الاختياري.

---

## 1. ترتيب تطبيق التنزيلات (ثابت وحيد)

السيرفر يطبّق التنزيلات بالترتيب التالي ولا يسمح بتغييره:

```
المجموع الفرعي (subtotal)
    ↓
1) קמפיינים (Campaign) — خصم حملة واحدة
    ↓ afterCampaign
2) קופונים (Coupon) — خصم كوبون واحد (على المبلغ بعد الحملة)
    ↓ afterCoupon
3) הצעות (Offers) — خصم عروض (نسبة/مبلغ/شحن مجاني/هدية) على المبلغ بعد الكوبون
    ↓ بعد خصم العروض
4) מתנות (Gifts) — هدايا قواعد + هدايا العروض (تُحسب على المجموع قبل الشحن بعد كل الخصومات)
    ↓
+ الشحن (أو 0 إن كان عرض شحن مجاني)
    ↓
المجموع النهائي (قبل/بعد ض.ق.م حسب الإعداد)
```

- **مصدر الحقيقة:** [pricing.service.js](src/services/pricing.service.js) — دالة `quotePricing()` (حوالي 1124–1195).
- **النتيجة:** لا يوجد تداخل عشوائي؛ كل طبقة تعمل على مبلغ واضح من الطبقة السابقة.

---

## 2. קמפיינים (Campaigns)

### ما يفعله السيرفر

- **حملة واحدة فقط** تُطبَّق لكل طلب.
- التصفية: `isActive: true` + التاريخ ضمن `startAt`/`endAt`.
- الاختيار: ترتيب حسب **الأولوية (priority)** تصاعدياً، ثم عند التعادل حسب **أعلى خصم محتمل**، ثم **الأحدث (createdAt)**.
- الخصم يُحسب على **مبلغ eligible** فقط:
  - `appliesTo: "all"` → كل عناصر السلة.
  - `appliesTo: "products"` → العناصر التي `productId` ضمن `productIds`.
  - `appliesTo: "categories"` → العناصر التي `categoryId` ضمن `categoryIds`.
- النوع: `percent` (نسبة من المبلغ المؤهل) أو `fixed` (مبلغ ثابت شيكل)، ولا يتجاوز الخصم أبداً **المجموع الفرعي الكامل** (subtotal).

### التقييم

- منطق اختيار الحملة **حتمي** وواضح.
- الـ model يفرض أن `products`/`categories` تحتوي معرّفات عند الحاجة ([Campaign.js](src/models/Campaign.js) pre-validate).
- **احترافي:** نعم.

---

## 3. קופונים (Coupons)

### ما يفعله السيرفر

- **كوبون واحد** لكل طلب (كود واحد).
- التحقق: الكود موجود، `isActive`، ضمن `startAt`/`endAt`، وتحقق **الحد الأدنى للطلب** `minOrderTotal` على المبلغ **بعد الحملة** (afterCampaign).
- حدود الاستخدام:
  - **عامة:** `usageLimit` — عدد مرات الاستخدام الإجمالي (`usedCount` + `reservedCount`).
  - **لكل مستخدم:** `usagePerUser` — عبر مجموعة `CouponUserUsage`.
- الخصم: `percent` أو `fixed`؛ إن وُجد `maxDiscount` يُطبَّق سقف.
- الخصم لا يتجاوز أبداً **المبلغ المُدخل لـ resolve** (afterCampaign).

### الحجز والاستهلاك (احترافي)

- **حجز (reserve)** عند بدء عملية الدفع: يزيد `reservedCount` ويُنشئ سجل `CouponReservation` (مع TTL).
- **استهلاك (consume)** عند تأكيد الطلب: يحوّل الحجز إلى `CouponRedemption` (فريد لكل coupon+order)، يزيد `usedCount` ويُنقص `reservedCount`.
- **تحرير (release)** عند إلغاء/فشل: يُنقص `reservedCount`.
- يمنع الاستخدام المزدوج لنفس الكوبون لنفس الطلب (idempotency عبر unique index).

### التقييم

- تطبيق الكوبون على **afterCampaign** صحيح.
- حدود الاستخدام والحجز والاستهلاك **متسقة وآمنة**.
- **احترافي:** نعم.

---

## 4. הצעות (Offers)

### ما يفعله السيرفر

- يمكن تطبيق **عدة عروض** حسب `stackable` و`priority`.
- التصفية: `isActive` + التاريخ ضمن النافذة؛ وشرط **الحد الأدنى للمجموع** `minTotal` على **المجموع بعد الكوبون** (subtotalAfterCoupon).
- الأنواع:
  - **PERCENT_OFF / FIXED_OFF:** خصم على مبلغ مؤهل (من عناصر مستهدفة أو كل السلة). الخصم يُقتطع من **المتبقي** بعد العروض السابقة؛ ولا يتجاوز أبداً `subtotalAfterCoupon` (سقف نهائي في نهاية evaluateOffers).
  - **FREE_SHIPPING:** يجعل رسوم الشحن = 0 (لا يغيّر المجموع الفرعي).
  - **BUY_X_GET_Y:** هدية فقط (بدون خصم مالي)؛ تحقق ستوك الهدية وتحذيرات نفاد/جزئي.
- الاستهداف: بدون `productIds`/`categoryIds` = كل السلة؛ معها = فقط العناصر المطابقة.
- **BUY_X_GET_Y:** دعم `buyVariantId` و`getVariantId` وكميات قابلة للتعديل؛ الضرب (مثلاً اشترِ 2 واحصل على 1، السلة فيها 4 → هدية 2) صحيح.

### التقييم

- ترتيب العروض وخصم المتبقي و**السقف النهائي** لخصم العروض (`Math.min(offersDiscountMinor, subtotalAfterCouponMinor)`) يمنع تجاوز المبلغ.
- **احترافي:** نعم.

---

## 5. מתנות (Gifts)

### ما يفعله السيرفر

- **قواعد (Gift):** تطابق حسب `minOrderTotal` و/أو `requiredProductId` و/أو `requiredCategoryId` على **المجموع قبل الشحن بعد كل الخصومات** (afterCoupon - offerAmount) وعناصر السلة؛ مع دعم **variant** و**qty** لكل قاعدة.
- **هدايا العروض (BUY_X_GET_Y):** من خدمة العروض مع تحقق ستوك.
- دمج الهدايا من المصدرين حسب `productId` + `variantId`؛ تحذيرات ستوك (نفاد/جزئي/منتج أو variant غير موجود) واضحة.
- عند **نفاد ستوك هدية بالكامل** (GIFT_OUT_OF_STOCK) يتم **رفض إتمام الطلب** (COD وStripe) بـ 400.

### التقييم

- قاعدة الهدايا تُحسب على المبلغ الصحيح (بعد كل الخصومات وقبل الشحن).
- الهدايا **تُخصم من الستوك** وتُخزَّن في الطلب ولا تُسترد في المرتجعات.
- **احترافي:** نعم.

---

## 6. نقاط القوة الإضافية

- **عمل بالـ minor units (أغوروت)** داخل الحساب لتقليل أخطاء الفاصلة العائمة.
- **شفافية في الـ quote:** `discounts.campaign`, `discounts.coupon`, `discounts.offer`، و`meta.appliedOffers` و`meta.giftWarnings` و`meta.campaignId`/`campaignName` تعطي الفرونت كل ما يحتاجه للعرض.
- **ض.ق.م (VAT):** دعم وضعين (شامل/غير شامل) مع تحقق في بيئة التطوير من تطابق المعادلة.
- **نماذج الحملة والعروض:** pre-validate في الـ schema يقلل إدخال بيانات خاطئة.

---

## 7. ملاحظات للتحسين (تم تطبيقها)

- **تحذير مبكر للكوبون (مُطبَّق):** عند طلب الـ quote مع كود كوبون، السيرفر يضيف في `meta.couponAvailability` نتيجة تحقق **بدون حجز فعلي**: `{ available: true }` أو `{ available: false, reason: "limit_reached" | "user_limit_reached" }`. الفرونت يمكنه عرض تحذير عندما `available === false` قبل إرسال الطلب.
- **توثيق ترتيب التنزيلات (مُطبَّق):** تعليق ثابت في [pricing.service.js](src/services/pricing.service.js) فوق تطبيق الخصومات يوضح أن الترتيب ثابت: حملة → كوبون → عروض → هدايا.
- **أولوية الحملة vs العروض:** حاليًا الحملة دائماً قبل الكوبون قبل العروض. إذا احتجت مستقبلاً "عرض لا يُطبَّق إلا بعد الكوبون" فهو موجود؛ لو احتجت "حملة بعد العروض" سيتطلب تغيير ترتيب في quotePricing.

---

## 8. التقييم النهائي

| المعيار | التقييم | ملاحظة |
|---------|---------|--------|
| ترتيب التطبيق | 10/10 | ثابت، واضح، ومُطبَّق كما هو متوقع |
| صحة الحساب (حدود، سقوف) | 10/10 | لا يتجاوز الخصم المبلغ المؤهل أو الفرعي |
| كوبونات (حدود، حجز، استهلاك) | 10/10 | آمنة وحتمية مع دعم per-user |
| حملات (واحدة، استهداف، أولوية) | 10/10 | منطق اختيار واحد وحساب eligible صحيح |
| عروض (نسبة/مبلغ/شحن/هدية) | 10/10 | سقف نهائي وستوك هدايا وstackable |
| هدايا (قواعد + عروض) | 10/10 | ستوك وتحذيرات ورفض عند نفاد |
| الشفافية للفرونت | 10/10 | discounts + meta كافية للعرض |
| **الإجمالي** | **9/10** | احترافي وجاهز للإنتاج؛ النقطة المخصومة للتحسينات الاختيارية (حجز كوبون مبكر، توثيق) وليس لأخطاء في المنطق |

**الخلاصة:** نظام التنزيلات (קופונים, הצעות, קמפיינים, מתנות) **معمول بشكل احترافي**، و**كل شيء يُحسب كما يجب** مع **منطق صحيح 100%** من ناحية الترتيب والحدود والستوك والشفافية. التقييم: **9/10** — مناسب للإنتاج وواثق من دقته.
